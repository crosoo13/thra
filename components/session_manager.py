# components/session_manager.py

import os
import logging
from dotenv import load_dotenv
from telethon.sync import TelegramClient
from telethon.errors import SessionPasswordNeededError
from telethon.sessions import StringSession

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –æ–±—â–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
from . import config
from . import database_manager as db

# –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –Ω–æ–º–µ—Ä—É —Ç–µ–ª–µ—Ñ–æ–Ω–∞
load_dotenv()
YOUR_PHONE_NUMBER = os.getenv('YOUR_PHONE_NUMBER')

async def create_new_session():
    """
    –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ —Å–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—É—é —Å—Ç—Ä–æ–∫–æ–≤—É—é —Å–µ—Å—Å–∏—é Telegram –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –µ–µ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö.
    
    –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è, –∫–æ–≥–¥–∞ –æ—Å–Ω–æ–≤–Ω–æ–π —Å–∫—Ä–∏–ø—Ç –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç –≤–∞–ª–∏–¥–Ω–æ–π —Å–µ—Å—Å–∏–∏.
    –û–Ω–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–ª–∏–µ–Ω—Ç–∞ (device_model, app_version), 
    —á—Ç–æ–±—ã –ø–æ–≤—ã—Å–∏—Ç—å —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å —Å–µ—Å—Å–∏–∏ –∏ –∏–∑–±–µ–∂–∞—Ç—å —Ä–∞–∑–ª–æ–≥–∏–Ω–∏–≤–∞–Ω–∏—è —Å–æ —Å—Ç–æ—Ä–æ–Ω—ã Telegram.

    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
        str: –°—Ç—Ä–æ–∫—É —Å–µ—Å—Å–∏–∏ –≤ —Å–ª—É—á–∞–µ —É—Å–ø–µ—Ö–∞.
        None: –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –∏–ª–∏ –æ—Ç–º–µ–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.
    """
    print("\n--- üîë –¢—Ä–µ–±—É–µ—Ç—Å—è –Ω–æ–≤–∞—è —Å–µ—Å—Å–∏—è Telegram ---")

    if not YOUR_PHONE_NUMBER:
        print("\n‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è YOUR_PHONE_NUMBER –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ .env —Ñ–∞–π–ª–µ!")
        return None

    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–ª–∏–µ–Ω—Ç —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –¥–ª—è –Ω–∞—à–µ–≥–æ "–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è",
    # —á—Ç–æ–±—ã Telegram —Å—á–∏—Ç–∞–ª –µ–≥–æ –ª–µ–≥–∏—Ç–∏–º–Ω—ã–º –∏ –Ω–µ —Ä–∞–∑–ª–æ–≥–∏–Ω–∏–≤–∞–ª.
    client = TelegramClient(
        StringSession(), 
        config.TELEGRAM_API_ID, 
        config.TELEGRAM_API_HASH,
        device_model="HR Vision Agent",
        system_version="Windows 11", # –ú–æ–∂–µ—Ç–µ —É–∫–∞–∑–∞—Ç—å –ª—é–±—É—é –û–°, –Ω–∞–ø—Ä–∏–º–µ—Ä "Ubuntu 22.04"
        app_version="1.0.0" # –í–µ—Ä—Å–∏—è –≤–∞—à–µ–≥–æ –±–æ—Ç–∞
    )

    session_string = None
    try:
        await client.connect()

        print(f" - –î–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –Ω–æ–º–µ—Ä: {YOUR_PHONE_NUMBER}")
        await client.send_code_request(YOUR_PHONE_NUMBER)
        print(" - –ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ Telegram.")

        try:
            await client.sign_in(YOUR_PHONE_NUMBER, input(' - –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è: '))
        except SessionPasswordNeededError:
            print(" - –¢—Ä–µ–±—É–µ—Ç—Å—è –ø–∞—Ä–æ–ª—å –¥–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ (2FA).")
            await client.sign_in(password=input(' - –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à –ø–∞—Ä–æ–ª—å 2FA: '))

        me = await client.get_me()
        if not me:
            raise Exception("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –ø–æ—Å–ª–µ –≤—Ö–æ–¥–∞.")

        print(f"\n‚úÖ –£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥ –æ—Ç –∏–º–µ–Ω–∏: {me.first_name} ({me.username})")

        # –ü–æ–ª—É—á–∞–µ–º —Å—Ç—Ä–æ–∫—É —Å–µ—Å—Å–∏–∏ –∏–∑ –æ–±—ä–µ–∫—Ç–∞ —Å–µ—Å—Å–∏–∏ –≤ –ø–∞–º—è—Ç–∏
        session_string = client.session.save()

        if not session_string or len(session_string) < 50:
            print("\n‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: TELEGRAM –ù–ï –í–ï–†–ù–£–õ –í–ê–õ–ò–î–ù–£–Æ –°–ï–°–°–ò–Æ!")
            return None

        print("--- ‚úÖ –°–µ—Å—Å–∏—è —É—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∞. ---")
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤–∞–ª–∏–¥–Ω—É—é —Å—Ç—Ä–æ–∫—É –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
        db.save_session_string(session_string)
        print("--- ‚úÖ –°–µ—Å—Å–∏—è —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö. ---")

    except Exception as e:
        print(f"\n‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ —Å–æ–∑–¥–∞–Ω–∏—è —Å–µ—Å—Å–∏–∏: {e}")
        return None
    finally:
        # –í–∞–∂–Ω–æ –æ—Ç–∫–ª—é—á–∞—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—ã–π –∫–ª–∏–µ–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –≤—Ö–æ–¥–∞
        if client.is_connected():
            await client.disconnect()
            print("\n--- –í—Ä–µ–º–µ–Ω–Ω—ã–π –∫–ª–∏–µ–Ω—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–µ—Å—Å–∏–∏ –æ—Ç–∫–ª—é—á–µ–Ω. ---")
    
    return session_string